<!--<!DOCTYPE html>-->
<!--<html lang="ko">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>AI 쓰레기 분류 도우미</title>-->
<!--    <script src="https://cdn.tailwindcss.com"></script>-->
<!--    <script src="https://unpkg.com/lucide@latest"></script>-->
<!--    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">-->
<!--    <style>-->
<!--        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }-->
<!--        .result-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }-->
<!--        .result-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }-->
<!--        /* 카메라 화면 스타일 */-->
<!--        #video-feed { transform: scaleX(-1); } /* 셀카 모드일 때 거울모드 */-->
<!--    </style>-->
<!--</head>-->
<!--<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">-->

<!--    <div class="w-full max-w-2xl bg-white p-6 md:p-10 rounded-xl shadow-2xl">-->
<!--        <header class="text-center mb-6">-->
<!--            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 flex items-center justify-center">-->
<!--                <i data-lucide="recycle" class="w-8 h-8 mr-3 text-green-600"></i>-->
<!--                AI 분리수거 도우미-->
<!--            </h1>-->
<!--            <p class="mt-2 text-gray-500">카메라로 쓰레기를 비추면 AI가 분석합니다.</p>-->
<!--        </header>-->

<!--        <div class="flex justify-center mb-6 bg-gray-100 p-1 rounded-lg">-->
<!--            <button id="tab-camera" class="w-1/2 py-2 rounded-md font-bold text-sm transition bg-white shadow text-green-700">-->
<!--                <i data-lucide="camera" class="inline w-4 h-4 mr-1"></i> 실시간 카메라-->
<!--            </button>-->
<!--            <button id="tab-upload" class="w-1/2 py-2 rounded-md font-bold text-sm text-gray-500 transition hover:bg-gray-200">-->
<!--                <i data-lucide="image" class="inline w-4 h-4 mr-1"></i> 앨범 업로드-->
<!--            </button>-->
<!--        </div>-->

<!--        <div id="camera-section" class="flex flex-col items-center">-->
<!--            <div class="relative w-full aspect-[4/3] bg-black rounded-lg overflow-hidden shadow-inner mb-4">-->
<!--                <video id="video-feed" autoplay playsinline class="w-full h-full object-cover"></video>-->
<!--                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">-->
<!--                    <div class="w-48 h-48 border-2 border-white/50 rounded-lg"></div> </div>-->
<!--            </div>-->

<!--            <button id="capture-btn" class="w-full py-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-lg flex items-center justify-center text-lg">-->
<!--                <i data-lucide="aperture" class="w-6 h-6 mr-2"></i>-->
<!--                찰칵! 촬영 및 분석-->
<!--            </button>-->
<!--        </div>-->

<!--        <div id="upload-section" class="hidden">-->
<!--            <div id="upload-area" class="border-2 border-dashed border-gray-300 p-10 rounded-lg text-center cursor-pointer hover:border-green-500 transition bg-gray-50">-->
<!--                <input type="file" id="file-input" accept="image/*" class="hidden">-->
<!--                <i data-lucide="cloud-upload" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>-->
<!--                <p class="text-gray-600 font-semibold">이미지 드래그 또는 클릭</p>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div id="result-section" class="mt-8 hidden border-t pt-6">-->
<!--            <div id="loading-indicator" class="hidden text-center py-4">-->
<!--                <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-green-500 mx-auto mb-3"></div>-->
<!--                <p class="text-gray-600 font-medium animate-pulse">AI가 쓰레기를 분석 중입니다...</p>-->
<!--            </div>-->

<!--            <img id="captured-preview" class="w-32 h-32 object-cover rounded-lg mx-auto mb-4 border hidden" alt="촬영된 이미지">-->

<!--            <div id="classification-result" class="flex flex-col gap-4"></div>-->
<!--        </div>-->

<!--        <canvas id="canvas" class="hidden"></canvas>-->
<!--    </div>-->

<!--    <script>-->
<!--        // [ 핵심 수정] 서버가 실행될 8000 포트와 예측 API 경로로 변경-->
<!--        const API_ENDPOINT = "http://127.0.0.1:8000/predict";-->

<!--        // DOM 요소 가져오기-->
<!--        const tabCamera = document.getElementById('tab-camera');-->
<!--        const tabUpload = document.getElementById('tab-upload');-->
<!--        const cameraSection = document.getElementById('camera-section');-->
<!--        const uploadSection = document.getElementById('upload-section');-->

<!--        const video = document.getElementById('video-feed');-->
<!--        const canvas = document.getElementById('canvas');-->
<!--        const captureBtn = document.getElementById('capture-btn');-->
<!--        const fileInput = document.getElementById('file-input');-->
<!--        const uploadArea = document.getElementById('upload-area');-->

<!--        const resultSection = document.getElementById('result-section');-->
<!--        const loadingIndicator = document.getElementById('loading-indicator');-->
<!--        const resultDiv = document.getElementById('classification-result');-->
<!--        const capturedPreview = document.getElementById('captured-preview');-->

<!--        let stream = null;-->

<!--        // -&#45;&#45; 탭 전환 로직 -&#45;&#45;-->
<!--        tabCamera.addEventListener('click', () => {-->
<!--            switchMode('camera');-->
<!--        });-->

<!--        tabUpload.addEventListener('click', () => {-->
<!--            switchMode('upload');-->
<!--        });-->

<!--        function switchMode(mode) {-->
<!--            resultSection.classList.add('hidden');-->
<!--            if (mode === 'camera') {-->
<!--                cameraSection.classList.remove('hidden');-->
<!--                uploadSection.classList.add('hidden');-->
<!--                tabCamera.classList.replace('text-gray-500', 'text-green-700');-->
<!--                tabCamera.classList.add('bg-white', 'shadow');-->
<!--                tabCamera.classList.remove('hover:bg-gray-200');-->

<!--                tabUpload.classList.replace('text-green-700', 'text-gray-500');-->
<!--                tabUpload.classList.remove('bg-white', 'shadow');-->
<!--                startCamera();-->
<!--            } else {-->
<!--                cameraSection.classList.add('hidden');-->
<!--                uploadSection.classList.remove('hidden');-->
<!--                tabUpload.classList.replace('text-gray-500', 'text-green-700');-->
<!--                tabUpload.classList.add('bg-white', 'shadow');-->
<!--                tabUpload.classList.remove('hover:bg-gray-200');-->

<!--                tabCamera.classList.replace('text-green-700', 'text-gray-500');-->
<!--                tabCamera.classList.remove('bg-white', 'shadow');-->
<!--                stopCamera();-->
<!--            }-->
<!--        }-->

<!--        // -&#45;&#45; 카메라 기능 (IR/Virtual 충돌 해결 로직 포함) -&#45;&#45;-->
<!--        async function startCamera() {-->
<!--            stopCamera(); // 기존 스트림 중지-->

<!--            try {-->
<!--                // 1. 모든 미디어 장치 목록 가져오기-->
<!--                const devices = await navigator.mediaDevices.enumerateDevices();-->
<!--                const videoDevices = devices.filter(device => device.kind === 'videoinput');-->

<!--                if (videoDevices.length === 0) {-->
<!--                    alert("사용 가능한 비디오 입력 장치가 없습니다.");-->
<!--                    return;-->
<!--                }-->

<!--                // 2. 적절한 카메라 장치 ID 선택 로직-->
<!--                let selectedDeviceId = null;-->

<!--                // **[핵심 로직]** IR/Virtual이 아닌 일반 내장 카메라를 우선 찾습니다.-->
<!--                let preferredDevice = videoDevices.find(device =>-->
<!--                    !device.label.toLowerCase().includes('ir camera') &&-->
<!--                    !device.label.toLowerCase().includes('virtual') &&-->
<!--                    (device.label.toLowerCase().includes('internal') || device.label.toLowerCase().includes('webcam'))-->
<!--                );-->

<!--                // 적절한 카메라를 찾지 못했다면, IR/Virtual이 아닌 첫 번째 장치를 선택합니다.-->
<!--                if (!preferredDevice) {-->
<!--                    preferredDevice = videoDevices.find(device =>-->
<!--                        !device.label.toLowerCase().includes('ir camera') &&-->
<!--                        !device.label.toLowerCase().includes('virtual')-->
<!--                    );-->
<!--                }-->

<!--                // 여전히 못 찾았다면, 목록의 첫 번째 장치를 사용합니다.-->
<!--                selectedDeviceId = preferredDevice ? preferredDevice.deviceId : videoDevices[0].deviceId;-->

<!--                // 3. 선택된 장치 ID를 사용하여 스트림 요청-->
<!--                stream = await navigator.mediaDevices.getUserMedia({-->
<!--                    video: {-->
<!--                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,-->
<!--                        facingMode: 'user' // 기본적으로 전면(내장) 카메라를 요청-->
<!--                    }-->
<!--                });-->

<!--                // 4. 비디오 요소에 스트림 연결-->
<!--                video.srcObject = stream;-->
<!--            } catch (err) {-->
<!--                console.error("카메라 접근 실패:", err);-->
<!--                alert("카메라를 사용할 수 없습니다. (에러: " + err.name + ")\n\n" +-->
<!--                      "여러 개의 카메라 장치(IR, 가상 카메라 등)가 충돌하고 있을 수 있습니다.\n" +-->
<!--                      "장치 관리자에서 사용하지 않는 카메라(IR, Virtual)를 '사용 안 함'으로 설정 후 다시 시도해보세요.");-->
<!--            }-->
<!--        }-->

<!--        function stopCamera() {-->
<!--            if (stream) {-->
<!--                stream.getTracks().forEach(track => track.stop());-->
<!--                video.srcObject = null;-->
<!--            }-->
<!--        }-->

<!--        // -&#45;&#45; 촬영 및 분석 요청 (중략) -&#45;&#45;-->
<!--        captureBtn.addEventListener('click', () => {-->
<!--            if (!stream) return;-->

<!--            canvas.width = video.videoWidth;-->
<!--            canvas.height = video.videoHeight;-->
<!--            const context = canvas.getContext('2d');-->
<!--            context.drawImage(video, 0, 0, canvas.width, canvas.height);-->

<!--            canvas.toBlob((blob) => {-->
<!--                const file = new File([blob], "capture.jpg", { type: "image/jpeg" });-->

<!--                capturedPreview.src = URL.createObjectURL(blob);-->
<!--                capturedPreview.classList.remove('hidden');-->

<!--                classifyImage(file);-->
<!--            }, 'image/jpeg');-->
<!--        });-->

<!--        // -&#45;&#45; 파일 업로드 로직 (중략) -&#45;&#45;-->
<!--        uploadArea.addEventListener('click', () => fileInput.click());-->
<!--        fileInput.addEventListener('change', (e) => {-->
<!--            if (e.target.files.length > 0) classifyImage(e.target.files[0]);-->
<!--        });-->

<!--        // -&#45;&#45; AI 분석 함수 (중략) -&#45;&#45;-->
<!--        async function classifyImage(file) {-->
<!--            resultSection.classList.remove('hidden');-->
<!--            loadingIndicator.classList.remove('hidden');-->
<!--            resultDiv.innerHTML = '';-->

<!--            const formData = new FormData();-->
<!--            formData.append('file', file);-->

<!--            try {-->
<!--                const response = await fetch(API_ENDPOINT, {-->
<!--                    method: 'POST',-->
<!--                    body: formData,-->
<!--                });-->

<!--                if (!response.ok) {-->
<!--                    const errorText = await response.text();-->
<!--                    try {-->
<!--                        const errorJson = JSON.parse(errorText);-->
<!--                        throw new Error(`Server Error (${response.status}): ${errorJson.detail || errorJson.message || '알 수 없는 서버 오류'}`);-->
<!--                    } catch {-->
<!--                        throw new Error("Server Error");-->
<!--                    }-->
<!--                }-->

<!--                const data = await response.json();-->

<!--                // 파일 업로드 시 미리보기 표시 추가-->
<!--                if (fileInput.files.length > 0 && !capturedPreview.classList.contains('hidden')) {-->
<!--                     capturedPreview.src = URL.createObjectURL(file);-->
<!--                     capturedPreview.classList.remove('hidden');-->
<!--                } else if (fileInput.files.length > 0) {-->
<!--                     capturedPreview.src = URL.createObjectURL(file);-->
<!--                     capturedPreview.classList.remove('hidden');-->
<!--                }-->


<!--                displayResult(data);-->

<!--            } catch (error) {-->
<!--                console.error("분석 중 오류 발생:", error);-->
<!--                resultDiv.innerHTML = `<p class="text-red-500 text-center font-bold">오류가 발생했습니다.<br>서버가 켜져있는지 (${API_ENDPOINT}) 확인해주세요.</p>`;-->
<!--            } finally {-->
<!--                loadingIndicator.classList.add('hidden');-->
<!--            }-->
<!--        }-->

<!--        // -&#45;&#45; 결과 표시 (디자인 업그레이드) -&#45;&#45;-->
<!--        function displayResult(result) {-->
<!--            // Top 1 결과-->
<!--            const label = result.predicted_class;-->
<!--            const confidence = (result.confidence).toFixed(1);-->
<!--            const style = getCategoryStyle(label);-->

<!--            const html = `-->
<!--                <div class="result-card bg-white border-l-8 border-${style.color}-500 rounded-lg p-6 shadow-lg flex items-center justify-between">-->
<!--                    <div>-->
<!--                        <p class="text-sm text-gray-500 font-bold mb-1">AI 분석 결과 (신뢰도 ${confidence}%)</p>-->
<!--                        <h2 class="text-4xl font-extrabold text-${style.color}-600 mb-2">${style.display_name}</h2>-->
<!--                        <p class="text-gray-600 text-sm">${style.desc}</p>-->
<!--                    </div>-->
<!--                    <div class="bg-${style.color}-100 p-4 rounded-full text-${style.color}-600">-->
<!--                        <i data-lucide="${style.icon}" class="w-12 h-12"></i>-->
<!--                    </div>-->
<!--                </div>-->
<!--            `;-->
<!--            resultDiv.innerHTML = html;-->
<!--            lucide.createIcons();-->
<!--        }-->

<!--        // 카테고리별 스타일 정의-->
<!--        function getCategoryStyle(label) {-->
<!--            const map = {-->
<!--                'plastic': { display_name: '플라스틱', icon: 'package', color: 'blue', desc: '내용물을 비우고 헹궈서 배출하세요.' },-->
<!--                'paper': { display_name: '종이', icon: 'book-open', color: 'yellow', desc: '이물질이 묻지 않게 펼쳐서 배출하세요.' },-->
<!--                // [수정 완료]: 캔 클래스에 금속류 포함 명시-->
<!--                'can': { display_name: '캔 (금속류)', icon: 'coffee', color: 'orange', desc: '내용물을 비우고 찌그러뜨려 배출하세요.' },-->
<!--                'glass': { display_name: '유리', icon: 'flask-conical', color: 'indigo', desc: '깨지지 않게 주의하여 배출하세요.' },-->
<!--                'general': { display_name: '일반쓰레기', icon: 'trash-2', color: 'red', desc: '종량제 봉투에 담아 버리세요.' },-->
<!--                'error': { display_name: '분류 오류', icon: 'alert-triangle', color: 'gray', desc: '모델 로드 또는 통신에 실패했습니다.' }-->
<!--            };-->
<!--            return map[label] || { display_name: '알 수 없음', icon: 'help-circle', color: 'gray', desc: '분류할 수 없습니다.' };-->
<!--        }-->

<!--        // 초기 실행: 카메라 시작-->
<!--        switchMode('camera');-->
<!--        lucide.createIcons();-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 쓰레기 분류 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .result-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .result-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        /* 카메라 화면 스타일 */
        #video-feed { transform: scaleX(-1); } /* 셀카 모드일 때 거울모드 */

        /* ⚠️ 추가된 경고 CSS */
        @keyframes pulse-warn {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .alert-pulse {
            animation: pulse-warn 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-2xl bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 flex items-center justify-center">
                <i data-lucide="recycle" class="w-8 h-8 mr-3 text-green-600"></i>
                AI 분리수거 도우미
            </h1>
            <p class="mt-2 text-gray-500">카메라로 쓰레기를 비추면 AI가 분석합니다.</p>
        </header>

        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-lg alert-pulse" role="alert">
            <div class="flex">
                <i data-lucide="lightbulb" class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5"></i>
                <div>
                    <p class="font-bold">분석 정확도 향상 팁!</p>
                    <p class="text-sm">현재 AI 모델은 흰색 배경에서 일반쓰레기를 **오분류**하는 경향이 있습니다. 물체를 **대비되는 어두운 배경** 위에 놓고 촬영하면 더 정확한 결과를 얻을 수 있습니다.</p>
                </div>
            </div>
        </div>
        <div class="flex justify-center mb-6 bg-gray-100 p-1 rounded-lg">
            <button id="tab-camera" class="w-1/2 py-2 rounded-md font-bold text-sm transition bg-white shadow text-green-700">
                <i data-lucide="camera" class="inline w-4 h-4 mr-1"></i> 실시간 카메라
            </button>
            <button id="tab-upload" class="w-1/2 py-2 rounded-md font-bold text-sm text-gray-500 transition hover:bg-gray-200">
                <i data-lucide="image" class="inline w-4 h-4 mr-1"></i> 앨범 업로드
            </button>
        </div>

        <div id="camera-section" class="flex flex-col items-center">
            <div class="relative w-full aspect-[4/3] bg-black rounded-lg overflow-hidden shadow-inner mb-4">
                <video id="video-feed" autoplay playsinline class="w-full h-full object-cover"></video>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-48 h-48 border-2 border-white/50 rounded-lg"></div> </div>
            </div>

            <button id="capture-btn" class="w-full py-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-lg flex items-center justify-center text-lg">
                <i data-lucide="aperture" class="w-6 h-6 mr-2"></i>
                찰칵! 촬영 및 분석
            </button>
        </div>

        <div id="upload-section" class="hidden">
            <div id="upload-area" class="border-2 border-dashed border-gray-300 p-10 rounded-lg text-center cursor-pointer hover:border-green-500 transition bg-gray-50">
                <input type="file" id="file-input" accept="image/*" class="hidden">
                <i data-lucide="cloud-upload" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
                <p class="text-gray-600 font-semibold">이미지 드래그 또는 클릭</p>
            </div>
        </div>

        <div id="result-section" class="mt-8 hidden border-t pt-6">
            <div id="loading-indicator" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-green-500 mx-auto mb-3"></div>
                <p class="text-gray-600 font-medium animate-pulse">AI가 쓰레기를 분석 중입니다...</p>
            </div>

            <img id="captured-preview" class="w-32 h-32 object-cover rounded-lg mx-auto mb-4 border hidden" alt="촬영된 이미지">

            <div id="classification-result" class="flex flex-col gap-4"></div>
        </div>

        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <script>
        // [ 핵심 수정] 서버가 실행될 8000 포트와 예측 API 경로로 변경
        const API_ENDPOINT = "http://127.0.0.1:8000/predict";

        // DOM 요소 가져오기
        const tabCamera = document.getElementById('tab-camera');
        const tabUpload = document.getElementById('tab-upload');
        const cameraSection = document.getElementById('camera-section');
        const uploadSection = document.getElementById('upload-section');

        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');

        const resultSection = document.getElementById('result-section');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultDiv = document.getElementById('classification-result');
        const capturedPreview = document.getElementById('captured-preview');

        let stream = null;

        // --- 탭 전환 로직 ---
        tabCamera.addEventListener('click', () => {
            switchMode('camera');
        });

        tabUpload.addEventListener('click', () => {
            switchMode('upload');
        });

        function switchMode(mode) {
            resultSection.classList.add('hidden');
            if (mode === 'camera') {
                cameraSection.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                tabCamera.classList.replace('text-gray-500', 'text-green-700');
                tabCamera.classList.add('bg-white', 'shadow');
                tabCamera.classList.remove('hover:bg-gray-200');

                tabUpload.classList.replace('text-green-700', 'text-gray-500');
                tabUpload.classList.remove('bg-white', 'shadow');
                startCamera();
            } else {
                cameraSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                tabUpload.classList.replace('text-gray-500', 'text-green-700');
                tabUpload.classList.add('bg-white', 'shadow');
                tabUpload.classList.remove('hover:bg-gray-200');

                tabCamera.classList.replace('text-green-700', 'text-gray-500');
                tabCamera.classList.remove('bg-white', 'shadow');
                stopCamera();
            }
        }

        // --- 카메라 기능 (IR/Virtual 충돌 해결 로직 포함) ---
        async function startCamera() {
            stopCamera(); // 기존 스트림 중지

            try {
                // 1. 모든 미디어 장치 목록 가져오기
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    alert("사용 가능한 비디오 입력 장치가 없습니다.");
                    return;
                }

                // 2. 적절한 카메라 장치 ID 선택 로직
                let selectedDeviceId = null;

                // **[핵심 로직]** IR/Virtual이 아닌 일반 내장 카메라를 우선 찾습니다.
                let preferredDevice = videoDevices.find(device =>
                    !device.label.toLowerCase().includes('ir camera') &&
                    !device.label.toLowerCase().includes('virtual') &&
                    (device.label.toLowerCase().includes('internal') || device.label.toLowerCase().includes('webcam'))
                );

                // 적절한 카메라를 찾지 못했다면, IR/Virtual이 아닌 첫 번째 장치를 선택합니다.
                if (!preferredDevice) {
                    preferredDevice = videoDevices.find(device =>
                        !device.label.toLowerCase().includes('ir camera') &&
                        !device.label.toLowerCase().includes('virtual')
                    );
                }

                // 여전히 못 찾았다면, 목록의 첫 번째 장치를 사용합니다.
                selectedDeviceId = preferredDevice ? preferredDevice.deviceId : videoDevices[0].deviceId;

                // 3. 선택된 장치 ID를 사용하여 스트림 요청
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                        facingMode: 'user' // 기본적으로 전면(내장) 카메라를 요청
                    }
                });

                // 4. 비디오 요소에 스트림 연결
                video.srcObject = stream;
            } catch (err) {
                console.error("카메라 접근 실패:", err);
                alert("카메라를 사용할 수 없습니다. (에러: " + err.name + ")\n\n" +
                      "여러 개의 카메라 장치(IR, 가상 카메라 등)가 충돌하고 있을 수 있습니다.\n" +
                      "장치 관리자에서 사용하지 않는 카메라(IR, Virtual)를 '사용 안 함'으로 설정 후 다시 시도해보세요.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // --- 촬영 및 분석 요청 (중략) ---
        captureBtn.addEventListener('click', () => {
            if (!stream) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
                const file = new File([blob], "capture.jpg", { type: "image/jpeg" });

                capturedPreview.src = URL.createObjectURL(blob);
                capturedPreview.classList.remove('hidden');

                classifyImage(file);
            }, 'image/jpeg');
        });

        // --- 파일 업로드 로직 (중략) ---
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) classifyImage(e.target.files[0]);
        });

        // --- AI 분석 함수 (중략) ---
        async function classifyImage(file) {
            resultSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            resultDiv.innerHTML = '';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`Server Error (${response.status}): ${errorJson.detail || errorJson.message || '알 수 없는 서버 오류'}`);
                    } catch {
                        throw new Error("Server Error");
                    }
                }

                const data = await response.json();

                // 파일 업로드 시 미리보기 표시 추가
                if (fileInput.files.length > 0 && !capturedPreview.classList.contains('hidden')) {
                    capturedPreview.src = URL.createObjectURL(file);
                    capturedPreview.classList.remove('hidden');
                } else if (fileInput.files.length > 0) {
                    capturedPreview.src = URL.createObjectURL(file);
                    capturedPreview.classList.remove('hidden');
                }


                displayResult(data);

            } catch (error) {
                console.error("분석 중 오류 발생:", error);
                resultDiv.innerHTML = `<p class="text-red-500 text-center font-bold">오류가 발생했습니다.<br>서버가 켜져있는지 (${API_ENDPOINT}) 확인해주세요.</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- 결과 표시 (디자인 업그레이드) ---
        function displayResult(result) {
            // Top 1 결과
            const label = result.predicted_class;
            const confidence = (result.confidence).toFixed(1);
            const style = getCategoryStyle(label);

            const html = `
                <div class="result-card bg-white border-l-8 border-${style.color}-500 rounded-lg p-6 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-bold mb-1">AI 분석 결과 (신뢰도 ${confidence}%)</p>
                        <h2 class="text-4xl font-extrabold text-${style.color}-600 mb-2">${style.display_name}</h2>
                        <p class="text-gray-600 text-sm">${style.desc}</p>
                    </div>
                    <div class="bg-${style.color}-100 p-4 rounded-full text-${style.color}-600">
                        <i data-lucide="${style.icon}" class="w-12 h-12"></i>
                    </div>
                </div>
            `;
            resultDiv.innerHTML = html;
            lucide.createIcons();
        }

        // 카테고리별 스타일 정의
        function getCategoryStyle(label) {
            const map = {
                'plastic': { display_name: '플라스틱', icon: 'package', color: 'blue', desc: '내용물을 비우고 헹궈서 배출하세요.' },
                'paper': { display_name: '종이', icon: 'book-open', color: 'yellow', desc: '이물질이 묻지 않게 펼쳐서 배출하세요.' },
                // [수정 완료]: 캔 클래스에 금속류 포함 명시
                'can': { display_name: '캔 (금속류)', icon: 'coffee', color: 'orange', desc: '내용물을 비우고 찌그러뜨려 배출하세요.' },
                'glass': { display_name: '유리', icon: 'flask-conical', color: 'indigo', desc: '깨지지 않게 주의하여 배출하세요.' },
                'general': { display_name: '일반쓰레기', icon: 'trash-2', color: 'red', desc: '종량제 봉투에 담아 버리세요.' },
                'error': { display_name: '분류 오류', icon: 'alert-triangle', color: 'gray', desc: '모델 로드 또는 통신에 실패했습니다.' }
            };
            return map[label] || { display_name: '알 수 없음', icon: 'help-circle', color: 'gray', desc: '분류할 수 없습니다.' };
        }

        // 초기 실행: 카메라 시작
        switchMode('camera');
        lucide.createIcons();
    </script>
</body>
</html>

